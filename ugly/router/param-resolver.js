"use strict";function firstToUpper(e){return e.charAt(0).toUpperCase()+e.slice(1)}function idToEntity(e){if(!e.param)throw new Error("param name is required!");var t=e.param,r=e.entity||e.param;return function(o,n,i){var s=o.params[t]||o.body[t]||o.query[t];if(!s){if(e.required){var a=new Error(e.param+" is required");return a.statusCode=400,i(a)}return debug('no param "%s"',t),o[t]=null,i()}if(!validMongoId(s)){if(e.required){var a=new Error(e.param+" id is invalid");return a.statusCode=400,i(a)}return o[t]=null,i()}debug('resolving "%s" with id "%s"',t,s);var u=require("../entity/"+r),c=u.Entity||u[firstToUpper(r)]||u;c.findById(s,function(r,n){if(r)return debug(r),o[t]=null,i(r);if(!n){if(e.required){var s=new Error(e.param+" not found");return s.statusCode=404,i(s)}return o[t]=null,i()}debug('instances of "%s" found',e.param),o[t]=n,i(null,n)})}}function validMongoId(e){return e.match(/^[a-fA-F0-9]{24}$/)}function hostnameToHost(e){return function(e,t,r){var o=e.params.hostname||e.body.hostname||e.query.hostname,n=e.customer;if(!n)return debug("no customer"),e.host=null,r();if(!o)return debug("no hostname"),e.host=null,r();debug('resolving host with hostname "%s"',o);var i={hostname:o,customer_name:n.name};Host.findOne(i,function(t,o){return t?(debug(t),void r(t)):null==o?(e.host=null,r()):(e.host=o,r())})}}function customerNameToEntity(e){return function(t,r,o){var n=t.params.customer||t.body.customer||t.query.customer;if(!n){if(e.required){var i=new Error("organization is required");return i.statusCode=403,o(i)}return debug("no customer"),t.customer=null,o()}debug('resolving customer with name "%s"',n);var s={name:n};Customer.findOne(s,function(r,n){if(r)return debug(r),o(r);if(!n){if(e.required){var i=new Error("organization not found");return i.statusCode=403,o(i)}return t.customer=null,o()}t.customer=n,o()})}}var debug=require("debug")("eye:router:middleware:params-resolver"),Host=require("../entity/host").Entity,User=require("../entity/user").Entity,Customer=require("../entity/customer").Entity;module.exports={idToEntity:idToEntity,hostnameToHost:hostnameToHost,customerNameToEntity:customerNameToEntity};