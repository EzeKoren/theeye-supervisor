"use strict";var debug=require("debug")("eye:supervisor:service:resource:template"),MonitorService=require("./monitor"),ResourceService=require("./index"),ResourceTemplate=require("../../entity/resource/template").Entity,MonitorTemplate=require("../../entity/monitor/template").Entity,ResourceMonitor=require("../../entity/monitor").Entity,Resource=require("../../entity/resource").Entity,_=require("lodash");exports.resourceMonitorToTemplate=function(e,t){ResourceMonitor.findById(e,function(r,o){if(r)throw r;if(!o){var n=new Error("resource monitor not found.");return n.statusCode=400,t(n)}Resource.findById(o.resource_id,function(r,n){if(r)throw r;if(!n){var i=new Error("resource not found. monitor id "+e);return i.statusCode=500,t(i)}o.toTemplate(function(e,r){n.toTemplate(function(e,o){t(null,{monitor:r,resource:o})})})})})},exports.createResourceMonitorsTemplates=function(e,t){var r={type:e.type,customer_id:e.customer_id,customer_name:e.customer_name,name:e.name,description:e.description,user_id:e.user_id};MonitorService.setMonitorData(e.type,e,function(e,o){if(e)throw e;if(!o){var n=new Error("invalid resource data");return n.statusCode=400,next(n)}delete o.host_id,ResourceTemplate.create(r,function(e,r){return e?debug(e):(debug("templates created"),o.template_resource=r._id,void MonitorTemplate.create(o,function(e,o){t(null,{monitor_template:o,resource_template:r})}))})})},exports.createMonitorFromTemplate=function(e){var t=e.done||function(){},r=e.template,o=e.host;MonitorTemplate.populate(r,{path:"template_resource"},function(e,n){var i=n.template_resource,s={host:o};Resource.FromTemplate(i,s,function(e,o){if(e)return debug("Resorce creation error %s",e.message),t(e);var i=_.extend(r,{host:s.host,host_id:s.host._id,resource:o._id,resource_id:o._id,template:n.id,id:null,customer_name:o.customer_name,_type:"ResourceMonitor"});debug("creating monitor from template %j",i);var a=new ResourceMonitor(i);a.save(function(e,r){return e?(debug(e.message),t(e)):(ResourceService.createDefaultEvents(a,o.customer_id),void t(null,{monitor:r,resource:o}))})})})};