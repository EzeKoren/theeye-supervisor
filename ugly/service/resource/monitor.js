"use strict";function setMonitorForScraper(e){var t=e.external_host_id?e.external_host_id:e.host_id,r=Boolean(e.external_host_id);return{tags:e.tags,customer_name:e.customer_name,host:t,host_id:t,name:e.name||"scraper",type:"scraper",looptime:e.looptime,config:{external:r,url:e.url,timeout:e.timeout,method:e.method,body:e.body,gzip:e.gzip,json:e.json,status_code:e.status_code,parser:e.parser,pattern:"pattern"==e.parser?e.pattern:null,script:"script"==e.parser?e.script:null}}}function setMonitorForProcess(e){return{tags:e.tags,customer_name:e.customer_name,host_id:e.host_id,host:e.host_id,name:e.name||"process",type:"process",looptime:e.looptime,config:{ps:{pattern:e.pattern,psargs:e.psargs}}}}function setMonitorForScript(e){return{tags:e.tags,customer_name:e.customer_name,host:e.host_id,host_id:e.host_id,name:e.name||"script",type:"script",looptime:e.looptime,config:{script_id:e.script_id,script_arguments:e.script_arguments,script_runas:e.script_runas}}}function setMonitorForHost(e){var t=e.looptime||1e4;return{tags:e.tags,customer_name:e.customer_name,host:e.host_id,host_id:e.host_id,type:"host",name:e.name||"host",looptime:t,config:{}}}function setMonitorForDstat(e){var t=e.looptime?e.looptime:1e4;return{tags:e.tags,customer_name:e.customer_name,host:e.host_id,host_id:e.host_id,type:"dstat",name:e.name||"dstat",looptime:t,config:{limit:{cpu:e.cpu||50,disk:e.disk||90,mem:e.mem||70,cache:e.cache||70}}}}function setMonitorForPsaux(e){var t=e.looptime?e.looptime:15e3;return{tags:e.tags,customer_name:e.customer_name,host:e.host_id,host_id:e.host_id,name:e.name||"psaux",type:"psaux",looptime:t,config:{}}}function setType(e,t){return t}function setMonitorData(e,t,r){var o;logger.log("setting up monitor data %j",t);try{switch(e){case"scraper":logger.log("scraper monitor"),o=setMonitorForScraper(t),r(null,o);break;case"process":if(logger.log("process monitor"),!t.pattern)throw new Error("search pattern required");o=setMonitorForProcess(t),r(null,o);break;case"script":logger.log("script monitor"),o=setMonitorForScript(t),r(null,o);break;case"dstat":o=setMonitorForDstat(t),r(null,o);break;case"psaux":o=setMonitorForPsaux(t),r(null,o);break;case"host":o=setMonitorForHost(t),r(null,o);break;default:throw new Error("monitor type "+e+" is invalid")}}catch(e){return logger.log("error processing monitor data"),e.statusCode=400,r(e,t)}}function validateData(e){var t=new ErrorHandler,r=e.type||e.monitor_type;r||t.required("type",r),e.looptime&&parseInt(e.looptime)||t.required("looptime",e.looptime),e.description||e.name||t.required("name",e.name);var o=_.assign({},e,{name:e.name||e.description,description:e.description||e.name,type:r,monitor_type:r,tags:filter.toArray(e.tags)});switch(logger.log("setting up resource type & properties"),logger.log(o),r){case"scraper":var n=e.url;n?validator.isURL(n,{require_protocol:!0})?o.url=n:t.invalid("url",n):t.required("url",n),o.timeout=e.timeout||1e4,o.external_host_id=e.external_host_id,e.external_host_id||(o.external=!1),e.parser?"script"!=e.parser&&"pattern"!=e.parser&&t.invalid("parser",e.parser):e.parser=null,e.status_code||e.pattern||e.script?e.parser&&("pattern"!=e.parser||e.pattern?"script"!=e.parser||e.script||t.invalid("script",e.script):t.invalid("pattern",e.pattern)):t.required("status code or parser");break;case"process":o.pattern=e.pattern||t.required("pattern"),o.psargs=e.psargs||"aux";break;case"script":var i=filter.toArray(e.script_arguments);o.script_arguments=i,o.script_id=e.script_id||t.required("script_id",e.script_id),o.script_runas=e.script_runas||"";break;case"dstat":o.cpu=e.cpu||60,o.mem=e.mem||60,o.cache=e.cache||60,o.disk=e.disk||60;break;case"psaux":break;default:t.invalid("type",r)}return{data:o,errors:t.hasErrors()?t:null}}function createMonitor(e,t,r){r||(r=function(){}),logger.log("processing monitor %s creation data",e),setMonitorData(e,t,function(o,n){if(o)return logger.log(o),r(o,n);if(null==n){var i="invalid resource data";logger.log(i);var o=new Error(i);return o.statusCode=400,r(o,data)}logger.log("creating monitor type %s",e),logger.log(n),n.resource=n.resource_id=t.resource._id,MonitorEntity.create(n,function(e,t){return e?(logger.log(e),r(e)):(logger.log("monitor %s created",t.name),r(null,t))})})}function findBy(e,t,r){function o(e,t){return logger.log("done searching"),e?(logger.error(e),r(e)):r(null,t)}var n={};e=e||{},"function"==typeof t?(r=t,t={}):(t=t||{},r=r||function(){});for(var i in e){var s=e[i];switch(i){case"enable":case"host_id":case"type":n[i]=s;break;case"script":n["config.script_id"]=s.toString()}}logger.log("running query %j",n),t.populate?(logger.log("populating monitors"),MonitorEntity.find(n).populate("resource").exec(o)):MonitorEntity.find(n).exec(o)}var _=require("lodash"),logger=require("../../lib/logger")("eye:supervisor:service:resource:monitor"),MonitorEntity=require("../../entity/monitor").Entity,ErrorHandler=require("../../lib/errorHandler"),filter=require("../../router/param-filter"),validator=require("validator"),ResourceTemplateService=require("./template"),ResourceService=require("./index"),Job=require("../../entity/job").Job;exports.findBy=findBy,exports.createMonitor=createMonitor,exports.setMonitorData=setMonitorData,exports.setType=setType,exports.validateData=validateData,exports.resourceMonitorsToTemplates=function(e,t,r,o){var n=r?r._id:null,i=t.name,s=t._id;if(!e){var a=new Error("resource monitors definition required");return a.statusCode=400,o(a)}if(!Array.isArray(e)){var a=new Error("resource monitors must be an array");return a.statusCode=400,o(a)}if(0==e.length)return logger.log("no resource monitoros. skipping"),o(null,[]);var u=_.after(e.length,function(){logger.log("all resources & monitorese templates processed"),o(null,c)});logger.log("processing %s resource monitors",e.length);for(var c=[],l=0;l<e.length;l++){var g=e[l];if(logger.log("processing resource monitors %j",g),0===Object.keys(g).length){var a=new Error("invalid resource monitor definition");return a.statusCode=400,o(a)}if(g.hasOwnProperty("id")){if(!validator.isMongoId(g.id)){var a=new Error("invalid monitor id");return a.statusCode=400,o(a)}logger.log("creating template from existent resource monitors"),ResourceTemplateService.resourceMonitorToTemplate(g.id,function(e,t){e&&o(e),logger.log("templates created"),c.push(t),u()})}else{logger.log("setting up template data");var d=validateData(g);if(!d||d.error){var m="invalid resource monitor data";logger.error(m);var f=new Error(m);return f.statusCode=400,f.info=d.error,o(f)}var p=d.data;p.customer_id=s,p.customer_name=i,p.user_id=n,logger.log("creating template from scratch"),ResourceTemplateService.createResourceMonitorsTemplates(p,function(e,t){return e?(logger.error(e),o(e)):(logger.log("templates from scratch created"),c.push(t),void u())})}}};