"use strict";function Service(e){function t(e,t){CustomerService.getCustomerConfig(e,function(e,r){t(r)})}function r(e,t){var r={date:(new Date).toISOString(),timestamp:(new Date).getTime(),state:t.state,hostname:e.hostname,customer_name:e.customer_name,resource_id:e._id,resource_name:e.name,resource_type:e.type,type:"resource-stats"},n=globalconfig.elasticsearch.keys.resource.stats;elastic.submit(e.customer_name,n,r)}function n(e,t){e.alerts!==!1&&ResourcesEmailNotifications(e,t.event,t.data,function(t,r){return t?(/event ignored/.test(t.message)===!1&&logger.error(t),void logger.log("alerts email not send")):(logger.log("sending email alerts"),void CustomerService.getAlertEmails(e.customer_name,function(t,n){NotificationService.sendEmailNotification({to:n.join(","),customer_name:e.customer_name,subject:r.subject,content:r.content})}))})}function o(e,t){MonitorEntity.findOne({resource_id:e._id},function(r,n){return n?(logger.log("searching monitor %s event %s ",n.name,t),void MonitorEvent.findOne({emitter:n._id,enable:!0,name:t},function(e,t){return e?logger.error(e):void(t&&EventDispatcher.dispatch(t))})):void logger.error("resource monitor not found %j",e)})}function i(e,t,i){var s=Constants.RESOURCE_FAILURE,a=i.fails_count_alert;if(logger.log('resource "%s" check fails.',e.name),e.fails_count++,logger.log("resource %s[%s] failure event count %s/%s",e.description,e._id,e.fails_count,a),e.state!=s&&e.fails_count>=a){logger.log('resource "%s" state failure',e.name);var c=getEventSeverity(t);t.severity=c,t.event||(t.event=t.state),e.failure_severity=c,e.last_event=t,e.state=s,n(e,t),r(e,t),o(e,s),u(e,{message:"monitor failure",data:t})}e.save(function(e){e&&logger.error(e)})}function s(e,t,i){logger.log('resource "%s" "%s" state is normal',e.type,e.name);var s=i.fails_count_alert,a=Boolean(e.state==Constants.RESOURCE_FAILURE);0!=e.fails_count&&(e.fails_count>=s&&(logger.log('resource "%s" "%s" has been restored',e.type,e.name),t.severity=getEventSeverity(t),a?t.event||(t.event=t.state):t.event=Constants.RESOURCE_RECOVERED,e.failure_severity=null,e.state=Constants.RESOURCE_NORMAL,e.fails_count=0,e.last_event=t,n(e,t),r(e,t),o(e,Constants.RESOURCE_RECOVERED),u(e,{message:t.message||"monitor normal",data:t})),e.save(function(e){e&&logger.error(e)}))}function a(e,t,i){var s=t.state,a=i.fails_count_alert;if(e.fails_count++,logger.log("resource %s[%s] notifications stopped count %s/%s",e.description,e._id,e.fails_count,a),e.state!=s&&e.fails_count>=a){logger.log('resource "%s" notifications stopped',e.name);var c=getEventSeverity(t);t.event||(t.event=t.state),t.severity=c,e.state=s,e.failure_severity=c,n(e,t),r(e,t),o(e,s),u(e,{message:"updates stopped",data:t})}e.save(function(e){e&&logger.error(e)})}function u(e,t){var r={state:e.state,customer_name:e.customer_name,resource:e.name,id:e.id,hostname:e.hostname,type:"resource",message:t.message,data:t.data};NotificationService.sendSNSNotification(r,{topic:"events",subject:"resource_update"})}function c(e){function t(e){var t=["success","ok","normal"];return t.indexOf(e.toLowerCase())!=-1}function r(e){var t=["error","fail","failure"];return t.indexOf(e.toLowerCase())!=-1}return"string"==typeof e&&t(e)?Constants.RESOURCE_NORMAL:"string"==typeof e&&r(e)?Constants.RESOURCE_FAILURE:e}var l=e;this.handleState=function(e,r){r||(r=function(){});var n=l,o=c(e.state);e.state=o,t(n.customer_id,function(t){if(!t)throw new Error("config not found");switch(e.state){case Constants.RESOURCE_NORMAL:e.last_update=Date.now(),s(n,e,t);break;case Constants.AGENT_STOPPED:case Constants.RESOURCE_STOPPED:a(n,e,t);break;default:case Constants.RESOURCE_FAILURE:e.last_update=Date.now(),i(n,e,t)}e.last_update&&(n.last_update=e.last_update),e.last_check&&(n.last_check=e.last_check),n.save(function(e){e&&logger.error(e)}),r()})}}function registerResourceCRUDOperation(e,t){var r=globalconfig.elasticsearch.keys.monitor.crud;elastic.submit(e,r,t)}function getEventSeverity(e){var t,r=e.event;return logger.log('resource event is "%s"',r),t=r&&/^host:stats:.*$/.test(r)?"LOW":"HIGH"}function handleHostIdAndData(e,t,r){Host.findById(e,function(n,o){if(n)return r(n);if(!o){var i=new Error("invalid host id "+e);return i.statusCode=400,r(i)}t.host_id=o._id,t.hostname=o.hostname,Service.create(t,r)})}function createResourceAndMonitor(e,t){var r=e.monitor_data,n=e.resource_data;logger.log("creating resource"),Resource.create(n,function(e,n){if(e)throw e;logger.log("creating resource %s monitor",n._id),logger.log(r),r.resource=n._id,r.resource_id=n._id,MonitorEntity.create(r,function(e,r){if(e)throw e;return t(null,{resource:n,monitor:r})})})}function updateMonitorsWithDeletedScript(e,t){t=t||function(){},logger.log('searching script "%s" resource-monitor',e._id);var r={type:"script",script:e._id},n={populate:!0};ResourceMonitorService.findBy(r,n,function(e,r){if(!r||0==r.length)return logger.log("no monitores linked to the script found."),t();for(var n=0;n<r.length;n++){var o=r[n];detachMonitorScript(o)}})}function detachMonitorScript(e,t){if(t=t||function(){},!e.resource._id){var r=new Error("populate monitor first. resource object required");return logger.error(r),t(r)}var n=e.resource;n.enable=!1,n.save(function(t){return t?logger.error(t):(e.enable=!1,e.config.script_id=null,e.config.script_arguments=[],void e.save(function(t){return t?logger.error(t):(logger.log("monitor changes saved"),logger.log('notifying "%s"',e.host_id),void AgentUpdateJob.create({host_id:e.host_id}))}))})}function notifyScriptMonitorsUpdate(e){var t={type:"script",script:e._id};ResourceMonitorService.findBy(t,function(e,t){if(!t||0==t.length)return void logger.log("no monitors with this script attached found.");for(var r=[],n=0;n<t.length;n++){var o=t[n];r.indexOf(o.host_id)===-1&&r.push(o.host_id)}for(var n=0;n<r.length;n++){var i=r[n];logger.log('notifying host "%s"',i),AgentUpdateJob.create({host_id:i})}})}var logger=require("../../lib/logger")("eye:supervisor:service:resource"),_=require("lodash"),elastic=require("../../lib/elastic"),CustomerService=require("../customer"),NotificationService=require("../notification"),ResourceMonitorService=require("./monitor"),EventDispatcher=require("../events"),Resource=require("../../entity/resource").Entity,MonitorEntity=require("../../entity/monitor").Entity,Host=require("../../entity/host").Entity,Task=require("../../entity/task").Entity,HostStats=require("../../entity/host/stats").Entity,Job=require("../../entity/job").Job,AgentUpdateJob=require("../../entity/job").AgentUpdate,Tag=require("../../entity/tag").Entity,MonitorEvent=require("../../entity/event").MonitorEvent,ResourcesEmailNotifications=require("./email-notifications"),globalconfig=require("config"),Constants=require("../../constants/monitors");module.exports=Service,Service.findHostResources=function(e,t,r){var n={host_id:e._id};t.type&&(n.type=t.type),Resource.find(n,function(n,o){return n?(logger.error(n),r(n)):o&&0!==o.length?t.ensureOne?o.length>1?(logger.error("more than one resource found for host %s type %s",e.hostname,t.type),r()):r(null,o[0]):void r(null,o):(logger.log("host resources not found for host %s",e.hostname),r())})},Service.create=function(e,t){t||(t=function(){}),logger.log("creating resource for host %j",e);var r=e.type||e.monitor_type,n={host:e.host,host_id:e.host_id,hostname:e.hostname,customer_id:e.customer_id,customer_name:e.customer_name,name:e.name,type:r,description:e.description};ResourceMonitorService.setMonitorData(r,e,function(r,o){if(r)return t(r);if(!o){var i=new Error("invalid resource data");return i.statusCode=400,t(i)}createResourceAndMonitor({resource_data:n,monitor_data:o},function(r,n){var o=n.monitor,i=n.resource;logger.log("resource & monitor created"),registerResourceCRUDOperation(o.customer_name,{name:o.name,type:i.type,customer_name:o.customer_name,user_id:e.user.id,user_email:e.user.email,operation:"create"}),Service.createDefaultEvents(o,e.customer),Tag.create(e.tags,e.customer),AgentUpdateJob.create({host_id:o.host_id}),t(null,n)})})},Service.createDefaultEvents=function(e,t,r){MonitorEvent.create({customer:t,emitter:e,name:Constants.RESOURCE_RECOVERED},{customer:t,emitter:e,name:Constants.RESOURCE_STOPPED},{customer:t,emitter:e,name:Constants.RESOURCE_FAILURE},function(e,t){e&&logger.error(e),r&&r(e,t)})},Service.update=function(e,t){var r=e.updates,n=e.resource;r.host&&(r.host_id=r.host._id,r.hostname=r.host.hostname),logger.log("updating monitor %j",r),n.patch(r,function(o){return o?t(o):void MonitorEntity.findOne({resource_id:n._id},function(o,i){if(o)return t(o);if(!i)return t(new Error("resource monitor not found"),null);var s=i.host_id;i.update(r,function(o){if(o)return t(o);registerResourceCRUDOperation(i.customer_name,{name:i.name,type:n.type,customer_name:i.customer_name,user_id:e.user.id,user_email:e.user.email,operation:"update"}),AgentUpdateJob.create({host_id:r.host_id}),s!=r.host_id&&AgentUpdateJob.create({host_id:s}),Tag.create(r.tags,{_id:n.customer_id});var a={resource:n,monitor:i};t(null,a)})})})},Service.fetchBy=function(e,t){var r=Resource.find(e.where);e.sort&&r.sort(e.sort),e.limit&&r.limit(e.limit),r.exec(function(e,r){if(e)return logger.error("unable to fetch resources from database"),logger.error(e),t(e,null);if(0===r.length)return t(null,[]);var n=[],o=_.after(r.length,function(){return t(null,n)});r.forEach(function(e){e.publish(function(t,r){MonitorEntity.findOne({resource_id:e._id},function(e,t){r.monitor=t,n.push(r),o()})})})})},Service.removeHostResource=function(e,t){function r(t,r){logger.log('removing host resource "%s"',t.name),Service.remove({resource:t,notifyAgents:!1,user:e.user},function(e){return e?r(e):(logger.log('resource "%s" removed',t.name),void r())})}var n=e.resource.host_id,o=e.resource._id;logger.log('removing host "%s" resource "%s" resources',n,o),Host.findById(n).exec(function(e,t){return e?logger.error(e):void(t&&t.remove(function(e){e&&logger.error(e)}))}),logger.log("removing host stats"),HostStats.find({host_id:n}).exec(function(e,t){if(t&&0!=t.length)for(var r=0;r<t.length;r++)t[r].remove(function(e){})}),Resource.find({host_id:n}).exec(function(e,t){if(0!=t.length)for(var n=_.after(t.length,function(){}),o=0;o<t.length;o++){var i=t[o];r(i,function(){n()})}}),logger.log("removing host jobs history"),Job.find({host_id:n}).exec(function(e,t){if(t&&0!=t.length)for(var r=0;r<t.length;r++)t[r].remove(function(e){})}),Task.find({host_id:n}).exec(function(e,t){if(t&&0!=t.length)for(var r=0;r<t.length;r++)t[r].host_id=null,t[r].save()})},Service.remove=function(e,t){t||(t=function(){});var r=e.resource,n=e.notifyAgents;logger.log('removing resource "%s" monitors',r.name),MonitorEntity.find({resource_id:r._id},function(o,i){if(0!==i.length){var s=i[0];s.remove(function(e){return e?logger.error(e):(MonitorEvent.remove({emitter:s._id},function(e){return logger.error(e)}),logger.log("monitor %s removed",s.name),void(n&&AgentUpdateJob.create({host_id:s.host_id})))})}else logger.error("monitor not found.");r.remove(function(n){return n?t(n):(registerResourceCRUDOperation(r.customer_name,{name:r.name,type:r.type,customer_name:r.customer_name,user_id:e.user.id,user_email:e.user.email,operation:"delete"}),void t())})})},Service.disableResourcesByCustomer=function(e,t){Resource.find({customer_id:e._id}).exec(function(e,t){if(0!=t.length)for(var r=0;r<t.length;r++){var n=t[r];n.enable=!1,n.save(function(e){if(e)throw logger.log("ERROR updating resource property"),e})}})},Service.createResourceOnHosts=function(e,t,r){r||(r=function(){}),logger.log("preparing to create resources"),logger.log(t);for(var n=null,o=[],i=_.after(e.length,function(){logger.log("all hosts processed"),r(n,o)}),s=function(e,t,r){t?(n=n||{},logger.log("there are some error %o",t),n[e]=t.message):(logger.log("host resource and monitor created"),o.push(r)),i()},a=0;a<e.length;a++){var u=e[a];handleHostIdAndData(u,t,function(t,r){s(e[a],t,r)})}},Service.onScriptRemoved=function(e){updateMonitorsWithDeletedScript(e)},Service.onScriptUpdated=function(e){notifyScriptMonitorsUpdate(e)};