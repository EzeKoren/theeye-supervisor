"use strict";function updateScriptFile(e,r,t){if(e){e.name!=r.filename?(logger.log("new file uploaded. removing old one"),e.keyname=getScriptKeyname(e.name),storageMedia.remove(r)):(logger.log("replace old uploaded file"),e.keyname=r.keyname);var o=fs.readFileSync(e.path);e.md5=md5(o),logger.log("saving file to media storage"),storageMedia.save({customer_name:r.customer_name,script:e},function(r,o){return r?(logger.error("cannot save script into storage"),logger.error(r),t(r)):t(null,e)})}else t()}function getScriptKeyname(e){return e+"[ts:"+Date.now()+"]"}function registerScriptCRUDOperation(e,r){var t=config.elasticsearch.keys.script.crud;elastic.submit(e,t,r)}var async=require("async"),md5=require("md5"),fs=require("fs"),config=require("config"),path=require("path"),extend=require("util")._extend,Script=require("../entity/script").Entity,Task=require("../entity/task").Entity,logger=require("../lib/logger")("eye:supervisor:service:script"),S3Storage=require("../lib/store").S3,LocalStorage=require("../lib/store").Local,elastic=require("../lib/elastic"),storageMedia=function(){return"local"==config.get("storage").driver?LocalStorage:S3Storage}(),Service={create:function(e,r){var t=this;e.script.keyname=getScriptKeyname(e.script.name);var o=fs.readFileSync(e.script.path);e.script.md5=md5(o),e.customer_name=e.customer.name,logger.log("saving file to storage"),storageMedia.save(e,function(o,n){o?(logger.error("unable to storage files."),logger.error(o.message),logger.error(o),r(o)):(logger.log("creating file entity"),t.createEntity(e,function(e,t){r&&r(e,t)}))})},createEntity:function(e,r){r||(r=function(){}),logger.log("creating script");var t={customer:e.customer,user:e.user,description:e.description||e.script.name,filename:e.script.name,keyname:e.script.keyname,mimetype:e.script.mimetype,extension:e.script.extension,size:e.script.size,md5:e.script.md5,public:e.public};Script.create(t,function(t,o){var n=e.customer.name;return t?r(t,null):(registerScriptCRUDOperation(n,{name:o.name,customer_name:n,user_id:e.user.id,user_email:e.user.email,operation:"create"}),r(null,o))})},update:function(e,r){r||(r=function(){});var t=e.script,o=e.file;updateScriptFile(o,t,function(n,i){var s=extend(e,{keyname:i.keyname,md5:i.md5,filename:o.name,mimetype:o.mimetype,size:o.size,extension:o.extension,last_update:new Date});logger.log("updating script"),t.update(s,function(o){return o?r(o):(registerScriptCRUDOperation(e.customer.name,{name:t.name,customer_name:e.customer.name,user_id:e.user.id,user_email:e.user.email,operation:"update"}),logger.log("script updated"),void r(null,t))})})},remove:function(e,r){r||(r=function(){});var t,o=e.script;storageMedia.remove(o,function(n,i){logger.log("script removed from storage");var s={_id:o._id};Script.remove(s,function(t){return t?r(t):(registerScriptCRUDOperation(e.customer.name,{name:o.name,customer_name:e.customer.name,user_id:e.user.id,user_email:e.user.email,operation:"delete"}),void r())}),t={script_id:o._id},Task.find(t,function(e,r){r.forEach(function(e,r){e.script_id=null,e.save()})})})},fetchBy:function(e,r){var t=[];Script.find(e,{},{sort:{description:1}},function(e,o){var n=null===o||o instanceof Array&&0===o.length;if(n)r([]);else{var i=[];o.forEach(function(e){i.push(function(r){e.publish(function(e,o){t.push(o),r()})})}),async.parallel(i,function(){r(t)})}})},getScriptStream:function(e,r){storageMedia.getStream(e.keyname,e.customer_name,r)}};module.exports=Service;