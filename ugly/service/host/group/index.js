"use strict";function hostProvisioning(e,t,r,o){t.publish({},function(t,n){logger.log("creating resource for host %s",e.hostname);var i=n.tasks,s=n.monitors,a=i.length+s.length;if(0==a)return logger.log("group is empty. not templates defined"),o();for(var u=lodash.after(a,function(){AgentUpdateJob.create({host_id:e._id}),o()}),c=0;c<i.length;c++){var l=i[c];TaskService.createFromTemplate({customer:r,templateData:l,host:e,done:u})}for(var c=0;c<s.length;c++){var l=s[c];logger.log("creating monitor %s",l.name),ResourceTemplateService.createMonitorFromTemplate({template:l,host:e,done:u})}})}function removeTemplateEntities(e,t,r){for(var o=0;o<e.length;o++){var n=e[o];t.remove({_id:n},function(e){if(e)return logger.error(e);var t=r.find({template:n});t.exec(function(e,t){if(e)return logger.error(e);for(var r=0;r<t.length;r++){var o=t[r];o.template=null,o.save(function(e){e&&logger.error(e)})}})})}}var lodash=require("lodash"),config=require("config"),logger=require("../../../lib/logger")("eye:service:host:group"),HostGroup=require("../../../entity/host/group").Entity,ResourceTemplate=require("../../../entity/resource/template").Entity,MonitorTemplate=require("../../../entity/monitor/template").Entity,TaskTemplate=require("../../../entity/task/template").Entity,Resource=require("../../../entity/resource").Entity,Monitor=require("../../../entity/monitor").Entity,Task=require("../../../entity/task").Entity,AgentUpdateJob=require("../../../entity/job").AgentUpdate,elastic=require("../../../lib/elastic"),TaskService=require("../../../service/task"),ResourceTemplateService=require("../../../service/resource/template");exports.Monitor=require("./monitor");var registerGroupCRUDOperation=function(e,t){var r=config.elasticsearch.keys.template.crud;elastic.submit(e,r,t)};exports.remove=function(e,t){var r=e.group,o=r.task_templates,n=r.resource_templates,i=r.monitor_templates;r.provisioning_task_templates;removeTemplateEntities(o,TaskTemplate,Task),removeTemplateEntities(n,ResourceTemplate,Resource),removeTemplateEntities(i,MonitorTemplate,Monitor),r.remove(function(o){return o?t(o):(registerGroupCRUDOperation(r.customer_name,{name:r.hostname_regex,customer_name:r.customer_name,user_id:e.user.id,user_email:e.user.email,operation:"delete"}),void t())})},exports.create=function(e,t){logger.log("creating group");var r,o=(e.user,e.customer),n=e.regex,i=e.tasks,s=e.resourcemonitors;e.provisioningtasks;try{r=new HostGroup,r.hostname_regex=n,r.customer=o._id,r.customer_name=o.name,r.task_templates=i.map(function(e){return e._id}),r.monitor_templates=[],r.resource_templates=[],r.provisioning_task_templates=[],s.forEach(function(e){r.addMonitorTemplate(e)}),logger.log(r)}catch(e){logger.log(e)}r.save(function(o){if(o)throw new o;registerGroupCRUDOperation(r.customer_name,{name:r.hostname_regex,customer_name:r.customer_name,user_id:e.user.id,user_email:e.user.email,operation:"create"}),t(null,r)})},exports.searchAndRegisterHostIntoGroup=function(e,t){logger.log("searching group for host %s",e.hostname),HostGroup.find({customer:e.customer_id}).populate("customer").exec(function(r,o){for(var n=0;n<o.length;n++){var i=o[n];if(logger.log("trying group %s",i.hostname_regex),new RegExp(i.hostname_regex).test(e.hostname)===!0)return logger.log("group found : %s",i.hostname_regex),void hostProvisioning(e,i,i.customer,function(e){return logger.log("provisioning completed"),e?t(e):void t(null,i)})}logger.log("group not found"),t(null)})};