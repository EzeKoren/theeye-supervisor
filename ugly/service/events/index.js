"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),EventEmitter=require("events").EventEmitter,util=require("util"),config=require("config").events,logger=require("../../lib/logger")("eye::events"),User=require("../../entity/user").Entity,Task=require("../../entity/task").Entity,ObjectId=require("mongoose").Types.ObjectId,CustomerService=require("../customer"),app=require("../../app"),EventDispatcher=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.user=null,r}return _inherits(t,e),_createClass(t,[{key:"initialize",value:function(e){function t(){logger.log("started"),e()}var r=this;this.user?t(null,user):User.findOne(config.user,function(e,o){if(e)throw e;o?(r.user=o,t(null,o)):(r.user=new User(config.user),r.user.save(function(e){if(e)throw e;t(null,o)}))})}},{key:"dispatch",value:function(e){var t=this;return logger.log("new event id %s name %s , type %s , emitter %s",e._id,e.name,e._type,e.emitter),Task.find({triggers:e._id},function(r,o){return r?logger.error(r):void(0!=o.length&&o.forEach(function(r){return t.createJob(r,e)}))}),this}},{key:"createJob",value:function(e,t){var r=this;logger.log("preparing to run task"),e.populate("customer_id",function(o){if(o)return logger.error(o);var n=e.customer_id;if(!n)return logger.error(new Error("task customer is not set, %j",e));var i=Date.now()+1e3*e.grace_time;e.grace_time>0?app.scheduler.scheduleTask({event:t,task:e,user:r.user,customer:n,schedule:{runDate:i},notify:!0},function(t,r){t&&logger.error(t),e.populate("host",function(t){CustomerService.getAlertEmails(n.name,function(t,o){app.jobDispatcher.sendJobCancelationEmail({task_id:e.id,schedule_id:r.attrs._id,task_name:e.name,hostname:e.host.hostname,date:new Date(i).toISOString(),grace_time_mins:e.grace_time/60,customer_name:n.name,to:o.join(",")})})})}):app.jobDispatcher.create({event:t,task:e,user:r.user,customer:n,notify:!0},function(e,t){return e?logger.error(e):void logger.log("automatic job created by event")})})}}]),t}(EventEmitter);module.exports=new EventDispatcher;