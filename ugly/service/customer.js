"use strict";function filterCustomer(e,r){for(var o=[],i=0;i<r.length;i++){var n=r[i];n._id!=e._id&&o.push(n)}return o}var config=require("config"),_=require("underscore"),logger=require("../lib/logger")("eye:supervisor:service:customer"),Customer=require("../entity/customer").Entity,User=require("../entity/user").Entity,ResourceMonitor=require("../entity/user").Entity,Service=module.exports={getAlertEmails:function(e,r){var o=[];Customer.findOne({name:e},function(i,n){if(i)return logger.log(i),r(i);if(!n){var s=new Error("customer "+e+" data does not exist!");return logger.error(s),r(s,[])}o=n.emails,User.find({"customers._id":n._id,credential:{$ne:"agent"}},function(e,i){return e?(logger.log(e),r(e)):(Array.isArray(i)&&i.length>0&&i.forEach(function(e){e.email&&o.push(e.email)}),r(null,o))})})},getCustomerConfig:function(e,r){Customer.findById(e,function(o,i){if(o)return logger.error(o),r(o);if(!i)return logger.error("customer %s not found",e),r(o);var n=_.extend(config.get("monitor"),i.config);r&&r(null,n)})},fetch:function(e,r){var o={};Customer.find(o,function(e,o){return e?r(e):r(null,o)})},create:function(e,r){var o={emails:e.emails,name:e.name,description:e.description||""},i=new Customer(o);i.save(function(e,o){return e?r(e):r(null,o)})},update:function(e,r,o){return e.description=r.description,e.emails=r.emails,e.save(function(r){return o(r,e)})},remove:function(e,r){logger.log("removing customer %s from users",e.name),User.find({"customers._id":e._id}).exec(function(r,o){if(o&&o.length>0)for(var i=0;i<o.length;i++){var n=o[i];if("agent"!=n.credential){var s=n.customers,t=filterCustomer(e,s);n.customers=t,n.save(function(e){e?logger.error(e):logger.log("user customers updated")})}else n.remove(function(r){r?logger.error(r):logger.log("customer %s agent user removed",e.name)})}}),e.remove(function(o){return o?void logger(o):(logger.log("customer %s removed",e.name),void r(null))})}};