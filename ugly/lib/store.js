"use strict";var AWS=require("aws-sdk"),path=require("path"),fs=require("fs"),zlib=require("zlib"),debug=require("debug")("eye:supervisor:lib:store"),config=require("config"),systemConfig=config.get("system"),S3Storage={save:function(e,t){var r={Bucket:config.get("s3").bucket,Key:e.script.keyname},o=new AWS.S3({params:r}),n=fs.createReadStream(e.script.path).pipe(zlib.createGzip());o.upload({Body:n}).on("httpUploadProgress",function(e){debug("upload progress %j",e)}).send(function(e,r){e?(debug("failed to create s3 script"),debug(e.message),t&&t(e,null)):t&&t(null,r)})},remove:function(e,t){t||(t=function(){});var r={Bucket:config.get("s3").bucket,Key:e.name},o=new AWS.S3({params:r});o.deleteObject(r,function(e,r){e?(debug("failed to remove s3 script"),debug(e.message),t(e)):t(null,r)})},getStream:function(e,t,r){var o={Bucket:config.get("s3").bucket,Key:e},n=new AWS.S3({params:o});n.getObject(o).on("error",function(e){r(e)}).createReadStream().pipe(zlib.createGunzip()).on("error",function(e){r(e)}).on("finish",function(){r(null,this)})}},LocalStorage={createCustomerScriptsPath:function(e,t){debug("creating customer script path");var r=systemConfig.file_upload_folder,o=r+"/"+e,n=o+"/scripts";fs.exists(n,function(r){r?t(n):fs.exists(o,function(r){r?fs.exists(n,function(r){r||(debug("customer %s scripts directory created",e),fs.mkdirSync(n,"0755")),t(n)}):(debug("customer %s directory created",e),fs.mkdirSync(o,"0755"),debug("customer %s scripts directory created",e),fs.mkdirSync(n,"0755"),t(n))})})},save:function(e,t){var r=e.script,o=r.keyname,n=r.path;this.createCustomerScriptsPath(e.customer_name,function(e){fs.rename(n,path.join(e,o),function(e){e?(debug(e),t(e,null)):t()})})},getStream:function(e,t,r){debug("getting script stream");var o=this,n=systemConfig.file_upload_folder,i=n+"/"+t,s=i+"/scripts",a=path.join(s,e);fs.access(a,fs.R_OK,function(e){return e?"ENOENT"!=e.code?r(e):void o.createCustomerScriptsPath(t,function(e){fs.writeFile(a,"EMPTY FILE CREATED",function(e){return e?r(e):void r(null,fs.createReadStream(a))})}):r(null,fs.createReadStream(a))})},remove:function(e,t){debug("REMOVE NOT IMPLEMENTED"),t&&t()}};module.exports={S3:S3Storage,Local:LocalStorage};