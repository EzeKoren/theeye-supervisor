"use strict";var debug=require("debug")("eye:controller:resource"),json=require("../lib/jsonresponse"),ResourceManager=require("../service/resource"),MonitorManager=require("../service/resource/monitor"),Resource=require("../entity/resource").Entity,ResourceMonitor=require("../entity/monitor").Entity,Host=require("../entity/host").Entity,Job=require("../entity/job").Job,resolver=require("../router/param-resolver"),dbFilter=require("../lib/db-filter");module.exports=function(e,t){var r=[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"resource"})];e.get("/:customer/resource",r,controller.fetch),e.get("/:customer/resource/:resource",r,controller.get),e.post("/:customer/resource",r,controller.create),e.put("/:customer/resource/:resource",r,controller.update),e.del("/:customer/resource/:resource",r,controller.remove),e.patch("/:customer/resource/:resource/alerts",r,controller.alerts),e.patch("/:customer/resource/:resource",r.concat(resolver.idToEntity({param:"host"})),controller.patch)};var controller={get:function(e,t,r){var o=e.resource;return o?void o.publish(function(e,r){t.send(200,{resource:r})}):t.send(404,json.error("not found"))},fetch:function(e,t,r){if(!e.customer)return t.send(403,json.error("specify an organization"));var o=dbFilter(e.query,{sort:{fails_count:-1,type:1}});o.where.customer_id=e.customer._id,ResourceManager.fetchBy(o,function(e,r){e||!r?t.send(500):t.send(200,r)})},remove:function(e,t,r){var o=e.resource;return o?void("host"==o.type?(debug("removing host resource"),ResourceManager.removeHostResource({resource:o,user:e.user}),t.send(204)):(debug("removing resource"),ResourceManager.remove({resource:o,notifyAgents:!0,user:e.user}),t.send(204))):t.send(404,json.error("not found"))},update:function(e,t,r){var o=e.resource,n=e.params,s=e.params.state;if(!o)return t.send(404,json.error("resource not found")),r();if(!s)return t.send(400,json.error("resource state is required")),r();var i=new ResourceManager(o);i.handleState(n,function(e){e?t.send(500,json.error("internal server error")):t.send(200)})},create:function(e,t,r){var o=e.customer,n=e.body.hosts;if(!o)return t.send(400,json.error("customer is required"));if(!n)return t.send(400,json.error("hosts are required"));Array.isArray(n)||(n=[n]);var s=MonitorManager.validateData(e.body);if(s.errors&&s.errors.hasErrors())return t.send(400,s.errors);var i=s.data;i.user=e.user,i.customer=o,i.customer_id=o.id,i.customer_name=o.name,ResourceManager.createResourceOnHosts(n,i,function(e,r){if(e){if(e.errors){var o=[];for(var n in e.errors){var s=errors[n];o.push({field:s.path,type:s.kind})}return t.send(400,json.error(e.message,{errors:o}))}return debug(e),t.send(500,json.error("internal error",e))}return debug("resources created"),t.send(201,r)})},patch:function(e,t,r){var o=e.resource;if(!o)return t.send(404,json.error("resource not found"));var n=MonitorManager.validateData(e.body);if(n.errors&&n.errors.hasErrors())return t.send(400,n.errors);var s=n.data;e.host&&(s.host=e.host),ResourceManager.update({resource:o,updates:s,user:e.user},function(e,r){e?t.send(500,json.error("update error",e.message)):t.send(200,r)})},alerts:function(e,t,r){if(!e.resource)return t.send(404);if(!e.customer)return t.send(400,"Customer required");var o=e.resource;o.alerts=e.params.alerts,o.save(function(e){e?t.send(500):t.send(200,o)})}};