"use strict";var debug=require("debug")("eye:supervisor:controller:resource"),json=require("../lib/jsonresponse"),_=require("lodash"),ResourceMonitor=require("../entity/monitor").Entity,paramsResolver=require("../router/param-resolver");module.exports=function(e,t){e.get("/monitor/:resource-monitor",[t.authenticate("bearer",{session:!1}),paramsResolver.idToEntity({param:"resource-monitor"})],controller.get),e.get("/monitor",[t.authenticate("bearer",{session:!1}),paramsResolver.customerNameToEntity({}),paramsResolver.idToEntity({param:"resource"})],controller.fetch)};var controller={get:function(e,t,r){var o=e["resource-monitor"];return o?(debug("publishing monitor"),void o.publish({},function(e,r){t.send(200,{monitor:r})})):t.send(404,json.error("monitor not found"))},fetch:function(e,t,r){var o=e.customer,n=e.resource,s=e.query.type;if(!o)return t.send(400,json.error("customer is required"));var i={customer_name:o.name};null!=n&&(i.resource_id=n._id),"undefined"!=typeof s&&(i.type=s),debug("fetching monitors by %j",i),ResourceMonitor.find(i).sort({host_id:1,type:1}).exec(function(e,r){var o=r.length;if(0==o)return t.send(200,{monitors:[]});for(var n=[],s=_.after(o,function(){t.send(200,{monitors:n})}),i=0;i<o;i++){var a=r[i];a.publish({populate:!0},function(e,t){null!=t&&n.push(t),s()})}})}};