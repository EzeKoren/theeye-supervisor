"use strict";var logger=require("../lib/logger")("eye:supervisor:controller:task"),json=require("../lib/jsonresponse"),TaskService=require("../service/task"),router=require("../router"),resolver=router.resolve,filter=router.filter,extend=require("lodash/assign");module.exports=function(e,t){var r=[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),router.userCustomer,resolver.idToEntity({param:"task"})];e.get("/:customer/task/:task",r,controller.get),e.patch("/:customer/task/:task",r,controller.patch),e.del("/:customer/task/:task",r,controller.remove),e.get("/:customer/task",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"host"})],controller.fetch),e.post("/:customer/task",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"script"})],controller.create)};var controller={create:function(e,t,r){var o=extend({},e.body,{customer:e.customer,user:e.user,script:e.script});if(!o.type)return t.send(400,json.error("type is required"));if(!o.customer)return t.send(400,json.error("customer is required"));if(!o.hosts)return t.send(400,json.error("a host is required"));if(Array.isArray(o.hosts)){if(0===o.hosts.length)return t.send(400,json.error("a host is required"))}else o.hosts=[o.hosts];if(!o.name)return t.send(400,json.error("name is required"));if("script"==o.type){if(!o.script)return t.send(400,json.error("script is required"))}else"scraper"==o.type;TaskService.createManyTasks(o,function(e,o){return e?(logger.error(e),t.send(500,e)):(t.send(200,o),void r())})},fetch:function(e,t,r){var o=e.host,n=e.customer,s={};n&&(s.customer_id=n._id),o&&(s.host_id=o._id),logger.log("fetching tasks"),TaskService.fetchBy(s,function(e,r){return e?t.send(500):void t.send(200,r)})},get:function(e,t,r){var o=e.task;return o?void o.publish(function(e){t.send(200,e)}):t.send(404)},remove:function(e,t,r){var o=e.task;return o?void TaskService.remove({task:o,user:e.user,customer:e.customer,done:function(){t.send(204)},fail:function(e){t.send(500)}}):t.send(404)},patch:function(e,t,r){if(!e.task)return t.send(404);var o=extend({},e.body);logger.log("updating task %j",o),TaskService.update({user:e.user,customer:e.customer,task:e.task,updates:o,done:function(e){t.send(200,e)},fail:function(e){logger.error(e),t.send(500)}})}};