"use strict";var json=require("../lib/jsonresponse"),Job=require("../entity/job").Job,JobDispatcher=require("../service/job"),debug=require("../lib/logger")("eye:supervisor:controller:job"),paramsResolver=require("../router/param-resolver");module.exports=function(e,t){e.get("/:customer/job/:job",[t.authenticate("bearer",{session:!1}),paramsResolver.customerNameToEntity({}),paramsResolver.idToEntity({param:"job"})],controller.get),e.put("/:customer/job/:job",[t.authenticate("bearer",{session:!1}),paramsResolver.customerNameToEntity({}),paramsResolver.idToEntity({param:"job",required:!0})],controller.update),e.get("/:customer/job",[t.authenticate("bearer",{session:!1}),paramsResolver.customerNameToEntity({}),paramsResolver.hostnameToHost({})],controller.fetch),e.post("/:customer/job",[t.authenticate("bearer",{session:!1}),paramsResolver.idToEntity({param:"task"}),paramsResolver.customerNameToEntity({})],controller.create)};var controller={get:function(e,t,r){var o=e.job;return o?void t.send(200,{job:o}):t.send(404,json.error("not found"))},fetch:function(e,t,r){if(debug.log("querying jobs"),!e.customer)return t.send(400,json.error("customer is required"));if(!e.host)return t.send(400,json.error("host is required"));var o=e.host,n=e.customer,i={host:e.host};e.params.process_next?JobDispatcher.getNextPendingJob(i,function(e,r){var o=[];null!=r&&o.push(r),t.send(200,{jobs:o})}):Job.find({host_id:o.id,customer_name:n.name}).exec(function(e,r){t.send(200,{jobs:r})})},update:function(e,t,r){var o=e.params.result;return o?(console.log(o),void JobDispatcher.update(e.job,o,function(e,o){return e?t.send(500):(t.send(200,o),void r())})):t.send(400,json.error("result data is required"))},create:function(e,t,r){debug.log("new task received");var o=e.task,n=e.user,i=e.customer;return o?n?i?void JobDispatcher.create({task:o,user:n,customer:i,notify:!0},function(e,r){return e?(debug.log(e),t.send(500)):void t.send(200,{job:r})}):t.send(400,json.error("customer required")):t.send(400,json.error("user required")):t.send(400,json.error("task required"))}};