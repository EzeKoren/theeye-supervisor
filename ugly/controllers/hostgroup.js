"use strict";var _=require("lodash"),async=require("async"),resolver=require("../router/param-resolver"),validator=require("../router/param-validator"),logger=require("../lib/logger")("eye:controller:template"),TaskService=require("../service/task"),ResourceMonitorService=require("../service/resource/monitor"),HostGroupService=require("../service/host/group"),TaskTemplate=require("../entity/task/template").Entity,MonitorTemplate=require("../entity/monitor/template").Entity,ResourceTemplate=require("../entity/resource/template").Entity,HostGroup=require("../entity/host/group").Entity;module.exports=function(e,t){e.get("/:customer/hostgroup/:group",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"group",entity:"host/group"})],controller.get),e.get("/:customer/hostgroup",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({})],controller.fetch),e.post("/:customer/hostgroup",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({})],controller.create),e.del("/:customer/hostgroup/:group",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"group",entity:"host/group"})],controller.remove)};var controller={get:function(e,t,r){var o=e.group;return o?void o.publish({},function(e,r){t.send(200,{group:r})}):t.send(400)},fetch:function(e,t,r){var o=e.customer;return o?void HostGroup.find({customer_name:o.name}).exec(function(e,r){if(0==r.length)return t.send(200,{groups:[]});for(var o=[],n=_.after(r.length,function(){t.send(200,{groups:o})}),i=0;i<r.length;i++){var s=r[i];s.publish({},function(e,t){o.push(t),n()})}}):t.send(400,"customer required")},create:function(e,t,r){if(logger.log("group data received %j",e.params),!e.customer)return t.send(400,"customer required");var o=e.params.group;if(!o)return t.send(400,"group data required");var n=o.hostname_regex;if(!n)return t.send(400,"hostname regexp required");try{new RegExp(n)}catch(e){return t.send(406,"Invalid regular expression")}var i=function(e){var r={error:e.message,info:[]};e.info&&r.info.push(e.info.toString()),t.send(e.statusCode,r)};async.parallel({tasks:function t(r){logger.log("processing group tasks");var t=o.tasks||[];TaskService.tasksToTemplates(t,e.customer,e.user,r)},provtasks:function t(r){logger.log("processing group provisioning tasks");var t=o.provtasks||[];TaskService.tasksToTemplates(t,e.customer,e.user,r)},resourcemonitors:function(t){logger.log("processing group monitors & resources");var r=o.monitors||[];ResourceMonitorService.resourceMonitorsToTemplates(r,e.customer,e.user,t)}},function(r,o){return r?i(r):void HostGroupService.create({user:e.user,regex:n,tasks:o.tasks,resourcemonitors:o.resourcemonitors,provisioningtasks:o.provtasks,customer:e.customer},function(e,r){return e?i(e):(logger.log("group created"),void t.send(200,{group:r}))})})},remove:function(e,t,r){var o=e.group;return o?void HostGroupService.remove({group:o,user:e.user},function(){return t.send(204)}):t.send(400)}};