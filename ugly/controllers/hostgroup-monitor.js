"use strict";function registerCRUDOperation(e,t){var r=config.elasticsearch.keys.template.monitor.crud;elastic.submit(e,r,t)}function validateRequest(e,t){return e.group?e.monitortemplate?e.group.hasMonitorTemplate(e.monitortemplate)?void 0:t.send(400,"task template does not belong to the group"):t.send(404,"task template not found"):t.send(404,"group not found")}function updateMonitorInstancesOnHostGroups(e,t){logger.log('updating template monitor "%s"(%s) instances',e.name,e._id),t=t||function(){};var r={template:e._id};Monitor.find(r).exec(function(r,o){if(r)return logger.error(r),t(r);if(!o||0==o.length)return logger.log("no monitors were found"),t();for(var n=0;n<o.length;n++){var i=o[n],s=e.values();i.update(s,function(e){return e?logger.error(e):void AgentUpdateJob.create({host_id:i.host_id})})}t()})}function updateResourceInstancesOnHostGroups(e,t){logger.log('updating template resource "%s"(%s) instances',e.description,e._id),t=t||function(){};var r={template:e._id};Resource.find(r).exec(function(r,o){if(r)return logger.error(r),t(r);if(!o||0==o.length)return logger.log("no resources were found"),t();for(var n=0;n<o.length;n++){var i=o[n];i.update(e.values(),function(e){return e?logger.error(e):void AgentUpdateJob.create({host_id:i.host_id})})}t()})}function doneError(e,t){return logger.error(e),t(e)}function removeTemplates(e,t){var r=e.template_resource;ResourceTemplate.findById(r,function(r,o){return r?doneError(r,t):o?(logger.log("removing resource template"),void o.remove(function(r){return r?doneError(r,t):(logger.log("removing monitor template"),void e.remove(function(e){return e?doneError(e,t):void t()}))})):t()})}var resolver=require("../router/param-resolver"),validator=require("../router/param-validator"),logger=require("../lib/logger")("eye:controller:template:monitor"),ResourceMonitorService=require("../service/resource/monitor"),GroupMonitorService=require("../service/host/group").Monitor,ResourceTemplate=require("../entity/resource/template").Entity,Monitor=require("../entity/monitor").Entity,Resource=require("../entity/resource").Entity,AgentUpdateJob=require("../entity/job").AgentUpdate,Host=require("../entity/host").Entity,config=require("config"),elastic=require("../lib/elastic");module.exports=function(e,t){e.get("/:customer/hostgroup/:group/monitortemplate/:monitortemplate",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"monitortemplate",entity:"monitor/template"}),resolver.idToEntity({param:"group",entity:"host/group"})],controller.get),e.put("/:customer/hostgroup/:group/monitortemplate/:monitortemplate",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"monitortemplate",entity:"monitor/template"}),resolver.idToEntity({param:"group",entity:"host/group"})],controller.update),e.get("/:customer/hostgroup/:group/monitortemplate",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"group",entity:"host/group"})],controller.fetch),e.post("/:customer/hostgroup/:group/monitortemplate",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"group",entity:"host/group"})],controller.create),e.del("/:customer/hostgroup/:group/monitortemplate/:monitortemplate",[t.authenticate("bearer",{session:!1}),resolver.customerNameToEntity({}),resolver.idToEntity({param:"monitortemplate",entity:"monitor/template"}),resolver.idToEntity({param:"group",entity:"host/group"})],controller.remove)};var controller={get:function(e,t,r){validateRequest(e,t);var o=e.monitortemplate;o.publish({},function(e,r){t.send(200,{monitor:r})})},fetch:function(e,t,r){if(!e.group)return t.send(404,"group not found");var o=e.group;o.publish({},function(e,r){var o=r.monitors;t.send(200,{monitors:o})})},create:function(e,t,r){if(!e.group)return t.send(404,"group not found");if(!e.body.monitor)return t.send(400,"monitors required");var o=e.group,n=[e.body.monitor];ResourceMonitorService.resourceMonitorsToTemplates(n,e.customer,e.user,function(r,n){if(r)return t.send(r.statusCode,r.message);var i=n[0].monitor_template.name;registerCRUDOperation(e.customer.name,{template:e.group.hostname_regex,name:i,customer_name:e.customer.name,user_id:e.user.id,user_email:e.user.email,operation:"create"}),GroupMonitorService.addTemplatesToGroup(o,n,function(e){if(e)return t.send(500);var r=n[0].monitor_template;t.send(200,{monitor:r})})})},update:function(e,t,r){validateRequest(e,t);var o=e.monitortemplate,n=e.body.monitor;e.group;return e.group?e.monitortemplate?e.body.monitor?void o.update(n,function(r,i){o.populate(function(t){var r=o.template_resource,i={name:n.name,description:n.description};r.update(i,function(t){registerCRUDOperation(e.customer.name,{template:e.group.hostname_regex,name:o.name,customer_name:e.customer.name,user_id:e.user.id,user_email:e.user.email,operation:"update"}),updateMonitorInstancesOnHostGroups(o,function(){updateResourceInstancesOnHostGroups(r,function(){logger.log("all updates done")})})})}),o.publish({},function(e,r){t.send(200,{monitor:r})})}):t.send(400,"invalid request. monitor required"):t.send(404,"monitor not found"):t.send(404,"group not found")},remove:function(e,t,r){validateRequest(e,t);var o=e.monitortemplate,n=e.group;GroupMonitorService.removeMonitorTemplateInstancesFromGroupHosts(o,function(r){return r?t.send(500):void removeTemplates(o,function(r){return r?t.send(500):(registerCRUDOperation(e.customer.name,{template:e.group.hostname_regex,name:o.name,customer_name:e.customer.name,user_id:e.user.id,user_email:e.user.email,operation:"delete"}),n.detachMonitorTemplate(o),void t.send(200))})})}};