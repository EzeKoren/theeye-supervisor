"use strict";var debug=require("../lib/logger")("eye:supervisor:controller:customer"),json=require("../lib/jsonresponse"),paramsResolver=require("../router/param-resolver"),CustomerService=require("../service/customer"),UserService=require("../service/user"),ResourceService=require("../service/resource"),HostService=require("../service/host");module.exports=function(e,t){e.get("/customer",[t.authenticate("bearer",{session:!1})],controller.fetch),e.get("/customer/:customer",[t.authenticate("bearer",{session:!1}),paramsResolver.idToEntity({param:"customer"})],controller.get),e.post("/customer",[t.authenticate("bearer",{session:!1})],controller.create),e.patch("/customer/:customer",[t.authenticate("bearer",{session:!1}),paramsResolver.idToEntity({param:"customer"})],controller.update),e.put("/customer/:customer",[t.authenticate("bearer",{session:!1}),paramsResolver.idToEntity({param:"customer"})],controller.replace),e.del("/customer/:customer",[t.authenticate("bearer",{session:!1}),paramsResolver.idToEntity({param:"customer"})],controller.remove)};var controller={get:function(e,t,r){var o=e.customer;return o?void t.send(200,{customer:o.publish()}):t.send(404,json.error("not found"))},fetch:function(e,t,r){CustomerService.fetch({},function(e,r){if(!e){for(var o=[],n=0;n<r.length;n++)o.push(r[n].publish());return t.send(200,{customers:o})}debug.error("error fetching customers"),t.send(500,json.error("failed to fetch customers"))})},create:function(e,t,r){var o=e.body;return o.name?o.email?void CustomerService.create(o,function(e,r){e?11e3==e.code?t.send(400,json.error(o.name+" customer already exists")):(debug.log(e),t.send(500,json.error("failed to create customer"))):(debug.log("new customer created"),UserService.create({email:r.name+"-agent@theeye.io",customers:[r.name],credential:"agent",enabled:!0},function(e,o){return e?(debug.error("creating user agent for customer"),debug.error(e),r.remove(function(e){return e?debug.error(e):void debug.log("customer %s removed",r.name)}),11e3==e.code?t.send(400,json.error("customer user agent already registered")):(debug.log(e),t.send(500,json.error("failed to create user agent"))),void 0):(debug.log("user agent created"),t.send(201,{customer:r.publish(),user:o.publish()}))}))}):t.send(400,json.error("email is required")):t.send(400,json.error("name is required"))},update:function(e,t,r){var o=e.customer;if(!o)return e.send(404,"not found");var n={};return e.params.description&&(n.description=e.params.description),e.params.emails&&(n.emails=e.params.emails),0===Object.keys(n).length?t.send(400,"nothing to update"):void CustomerService.update(o,n,function(e,r){return t.send(205,{customer:r})})},replace:function(e,t,r){var o=e.customer;if(!o)return e.send(404,"not found");var n=e.params.description||"",i=e.params.emails||[],s={description:n,emails:i};CustomerService.update(o,s,function(e,r){return t.send(205,{customer:r})})},remove:function(e,t,r){var o=e.customer;return o?void CustomerService.remove(o,function(e){return e?t.send(500):(HostService.disableHostsByCustomer(o),ResourceService.disableResourcesByCustomer(o),t.send(204))}):e.send(404)}};