"use strict";function registerHostname(e,t){var r=e.customer,o=e.hostname,n=e.host_properties;Host.findOne({hostname:o,customer_name:r.name},function(i,s){if(i)return t(i);if(!s)return debug("hostname '%s' not found.",o),HostService.register({user:e.user,hostname:o,customer:r,info:n},function(e,r){if(e)return t(e);t(e,r);var o=r.host;NotificationService.sendSNSNotification({resource:"host",event:"host_registered",customer_name:o.customer_name,hostname:o.hostname},{topic:"events",subject:"host_registered"})});var a=function(){debug("updating agent version"),s.agent_version=n.agent_version,s.last_update=new Date,s.save();var e={customer_name:r.name,hostname:s.hostname,version:s.agent_version},t=config.elasticsearch.keys.agent.version;elastic.submit(r.name,t,e)};if(debug("host found"),!s.enable){var i=new Error("host is disabled");return i.statusCode=400,t(i)}a(),Resource.findOne({host_id:s._id,type:"host"},function(e,r){if(e)return t(e);if(!r){debug('resource for registered host "%s" not found',s._id);var e=new Error("host resource not found");return e.statusCode=500,t(e,{host:s})}return t(null,{host:s,resource:r})})})}var debug=require("debug")("eye:supervisor:controller:host"),config=require("config"),_=require("underscore"),json=require("../lib/jsonresponse"),Host=require("../entity/host").Entity,Resource=require("../entity/resource").Entity,HostService=require("../service/host"),paramsResolver=require("../router/param-resolver"),NotificationService=require("../service/notification"),elastic=require("../lib/elastic");module.exports=function(e,t){e.get("/host/:host",[t.authenticate("bearer",{session:!1}),paramsResolver.idToEntity({param:"host"})],controller.get),e.get("/host",[t.authenticate("bearer",{session:!1}),paramsResolver.customerNameToEntity({})],controller.fetch),e.post("/host/:hostname",[t.authenticate("bearer",{session:!1}),paramsResolver.customerNameToEntity({})],controller.create)};var controller={get:function(e,t,r){var o=e.host;return o?void o.publish(function(e){return t.send(200,{host:e})}):t.send(404)},create:function(e,t,r){var o=e.params.hostname,n=e.customer,i=e.params.info;if(i.agent_version=e.params.version,!n){var s=json.error("customer is required");return t.send(400,s)}debug('processing hostname "%s" registration request',o),registerHostname({user:e.user,customer:n,hostname:o,host_properties:i},function(e,n){e&&debug(e);var i=n.host,s=n.resource;debug('host "%s" registration completed.',o);var a=_.extend({resource_id:s?s._id:null,host_id:i._id},config.get("agent.core_workers.host_ping"));t.send(200,a),r()})},fetch:function(e,t,r){var o=e.customer,n=e.params.scraper;return o?void(n?HostService.fetchBy({customer_name:"theeye"},function(e,r){e?t.send(500):t.send(200,{hosts:r})}):HostService.fetchBy({customer_name:o.name},function(e,r){e?t.send(500):t.send(200,{hosts:r})})):t.send(400,json.error("customer is required"))}};