"use strict";var path=require("path"),mime=require("mime"),fs=require("fs"),json=require("../lib/jsonresponse"),debug=require("../lib/logger")("eye:supervisor:controller:script"),resolve=require("../router/param-resolver"),validate=require("../router/param-validator"),filter=require("../router/param-filter"),ScriptService=require("../service/script"),ResourceService=require("../service/resource"),Script=require("../entity/script").Entity,extend=require("util")._extend;module.exports=function(e,t){e.get("/:customer/script",[t.authenticate("bearer",{session:!1}),resolve.customerNameToEntity({})],controller.fetch),e.post("/:customer/script",[t.authenticate("bearer",{session:!1}),resolve.customerNameToEntity({})],controller.create),e.get("/:customer/script/:script",[resolve.customerNameToEntity({}),t.authenticate("bearer",{session:!1}),resolve.idToEntity({param:"script"})],controller.get),e.patch("/:customer/script/:script",[resolve.customerNameToEntity({}),t.authenticate("bearer",{session:!1}),resolve.idToEntity({param:"script"})],controller.update),e.del("/:customer/script/:script",[resolve.customerNameToEntity({}),t.authenticate("bearer",{session:!1}),resolve.idToEntity({param:"script"})],controller.remove)};var controller={fetch:function(e,t,r){var o=e.user,n=e.customer;return n?o?(ScriptService.fetchBy({customer_name:n.name},function(e){e||(e=[]),t.send(200,{scripts:e})}),void r()):t.send(400,json.error("invalid user")):t.send(400,json.error("customer is required"))},get:function(e,t,r){var o=e.script;e.customer;return o?(o.publish(function(e,r){t.send(200,{script:r})}),void r()):t.send(404,json.error("not found"))},create:function(e,t,r){var o=e.user,n=e.customer,s=e.files.script;if(!o)return t.send(400,json.error("invalid user"));if(!s)return t.send(400,json.error("invalid script",s));if(!validate.isValidFilename(s.name))return t.send(400,json.error("invalid filename",s.name));var i=e.body.description,a=e.body.name;debug.log("creating script"),ScriptService.create({customer:n,user:o,description:i,name:a,public:e.body.public||!1,script:s},function(e,r){e?(debug.error(e),t.send(500,json.error("internal server error",{error:e.message}))):r.publish(function(e,r){t.send(200,r)})}),r()},remove:function(e,t,r){var o=e.script;return o?void ScriptService.remove({script:o,user:e.user,customer:e.customer},function(e,r){return e?(debug.error(e),t.send(500)):(ResourceService.onScriptRemoved(o),void t.send(204))}):t.send(404,json.error("script not found"))},update:function(e,t,r){var o=e.script,n=e.files.script,s=e.body;if(!o)return t.send(404);if(!n)return t.send(400,"script file is required");var i=extend(s,{customer:e.customer,user:e.user,script:o,file:n});ScriptService.update(i,function(e,r){return e?t.send(500):(ResourceService.onScriptUpdated(r),void r.publish(function(e,r){t.send(200,{script:r})}))})}};