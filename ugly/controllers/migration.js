"use strict";function createMonitorTypeHost(e){Resource.find({type:"host"},function(t,r){var o=_.after(r.length,function(){return e()});r.forEach(function(e){ResourceMonitor.find({type:"host",host_id:e.host_id},function(t,r){if(0!=r.length)return o();var n=_.assign({},e.toObject(),{resource:e});MonitorService.createMonitor("host",n,function(e){return o()})})})})}function removeAllDstatPsaux(e){ResourceMonitor.remove({type:"dstat"},function(t){return t?e(t):void Resource.remove({type:"dstat"},function(t){return t?e(t):void ResourceMonitor.remove({type:"psaux"},function(t){return t?e(t):void Resource.remove({type:"psaux"},function(t){return t?e(t):void e()})})})})}function createHostsDstatPsaux(e){Host.find(function(e,t){t.forEach(function(e){Resource.find({type:"host",template:null,host_id:e._id},function(t,r){if(0!=r.length){var o=(r[0],Object.assign({},e.toObject(),{host_id:e._id,name:"dstat",monitor_type:"dstat",description:"host stats"}));delete o._id,createMonitor([e],o);var n=Object.assign({},e.toObject(),{host_id:e._id,name:"psaux",monitor_type:"psaux",description:"host process"});delete n._id,createMonitor([e],n)}})})}),e()}function removeMonitorsAndTasksLinkedToTemplates(e){var t={template:{$ne:null}};Task.remove(t,function(r){ResourceMonitor.remove(t,function(r){t.type={$ne:"host"},Resource.remove(t,function(t){Resource.find({type:"host"},function(e,t){t.forEach(function(e){e.template=null,e.save()})}),e()})})})}function createDstatPsaux(e){var t={name:e.customer_name,_id:e.customer},r=null;ResourceMonitorService.resourceMonitorsToTemplates([dstatConfig,psauxConfig],t,r,function(t,r){return t?console.log(t):void HostGroupService.Monitor.addTemplatesToGroup(e,r)})}var MonitorService=require("../service/resource/monitor"),ResourceService=require("../service/resource"),ResourceMonitorService=require("../service/resource/monitor"),HostGroupService=require("../service/host/group"),Task=require("../entity/task").Entity,Resource=require("../entity/resource").Entity,ResourceMonitor=require("../entity/monitor").Entity,Host=require("../entity/host").Entity,HostGroup=require("../entity/host/group").Entity,_=require("lodash"),createMonitor=ResourceService.createResourceOnHost;module.exports=function(e){};var controller={createHostMonitors:function(e,t){createMonitorTypeHost(function(){t.send()})},createBaseResources:function(e,t){removeAllDstatPsaux(function(e){return e?t.send(500):void createHostsDstatPsaux(function(e){return e?t.send(500):void t.send(200)})})},addDstatPsauxToTemplates:function(e,t){return HostGroup.find(function(e,t){t.forEach(function(e){createDstatPsaux(e)})}),t.send(200)},relinkHostResourcesToGroups:function(e,t){var r=e.params.unlink_only;t.send("processing"),removeMonitorsAndTasksLinkedToTemplates(function(){console.log("templates unlinked"),r||Host.find(function(e,t){t.forEach(function(e){HostGroupService.searchAndRegisterHostIntoGroup(e,function(t,r){r&&Resource.find({type:"host",host_id:e._id},function(e,t){var o=t[0];o.template=r,o.save()})})})})})}},dstatConfig={_type:"monitor",monitor_type:"dstat",description:"Host Stats",looptime:"30000"},psauxConfig={_type:"monitor",monitor_type:"psaux",description:"Host Process",looptime:"30000"};