"use strict";var extend=require("lodash/assign"),dbFilter=require("../lib/db-filter"),logger=require("../lib/logger")("eye:controller:webhook"),audit=require("../lib/audit"),router=require("../router"),resolve=router.resolve,EventDispatcher=require("../service/events"),WebhookEvent=require("../entity/event").WebhookEvent,Webhook=require("../entity/webhook").Webhook;module.exports=function(e,t){var r=[t.authenticate("bearer",{session:!1}),resolve.customerNameToEntity({required:!0}),router.userCustomer];e.get("/:customer/webhook",r,controller.fetch),e.post("/:customer/webhook",r,controller.create,audit.afterCreate("webhook",{display:"name"})),e.get("/:customer/webhook/:webhook",r.concat(resolve.idToEntity({param:"webhook",required:!0})),controller.get),e.put("/:customer/webhook/:webhook",r.concat(resolve.idToEntity({param:"webhook",required:!0})),controller.update,audit.afterUpdate("webhook",{display:"name"})),e.del("/:customer/webhook/:webhook",r.concat(resolve.idToEntity({param:"webhook",required:!0})),controller.remove,audit.afterRemove("webhook",{display:"name"})),e.post("/:customer/webhook/:webhook/trigger",r.concat(resolve.idToEntity({param:"webhook",required:!0})),controller.trigger),e.post("/:customer/webhook/:webhook/trigger/secret/:secret",[resolve.customerNameToEntity({required:!0}),resolve.idToEntity({param:"webhook",required:!0}),function(e,t,r){var o=e.params.secret;return o?64!=o.length?t.send(403,"invalid secret"):e.webhook.secret!=o?t.send(403,"invalid secret"):void r():t.send(403,"secret is required")}],controller.trigger)};var controller={fetch:function(e,t,r){var o=dbFilter(extend(e.query||{},{where:{customer:e.customer}}));Webhook.find(o.where,function(e,r){return e?t.send(500):void t.send(200,r)})},create:function(e,t,r){var o=extend({},e.body,{customer:e.customer}),n=new Webhook(o);n.save(function(o){return o?"ValidationError"==o.name?t.send(400,o):t.send(500):(t.send(200,n),e.webhook=n,void r())})},update:function(e,t,r){var o=e.webhook,n=extend({},e.body,{customer:e.customer});extend(o,n),o.save(function(e){return e?t.send(500):(t.send(200,o),void r())})},get:function(e,t,r){var o=e.webhook;return t.send(200,o)},remove:function(e,t,r){var o=e.webhook;o.remove(function(e){return e?t.send(500):(t.send(200,o),void r())})},trigger:function(e,t,r){var o=e.webhook;WebhookEvent.findOne({emitter:o._id},function(e,o){return e?t.send(500,e):o?(EventDispatcher.dispatch(o),t.send(202,{message:"success"}),void r()):t.send(500)})}};