"use strict";var json=require("../lib/jsonresponse"),logger=require("../lib/logger")("eye:supervisor:controller:agent"),NotificationService=require("../service/notification"),paramsResolver=require("../router/param-resolver"),Host=require("../entity/host").Entity,ResourceManager=require("../service/resource");module.exports=function(e,t){e.put("/:customer/agent/:hostname",[t.authenticate("bearer",{session:!1}),paramsResolver.customerNameToEntity({}),paramsResolver.hostnameToHost({})],controller.update)};var controller={update:function(e,t,r){var o=e.host;return o?(logger.log('receiving agent keep alive for host "%s"',o.hostname),o.last_update=new Date,o.save(function(e){if(e)return logger.error(e);var t={type:"host",ensureOne:!0};ResourceManager.findHostResources(o,t,function(e,t){if(!e&&t){var r=new ResourceManager(t);r.handleState({state:"normal"})}})}),t.send(200),r()):(logger.error("invalid request for id %s. host not found",e.params.hostname),t.send(404,"invalid host"))}};