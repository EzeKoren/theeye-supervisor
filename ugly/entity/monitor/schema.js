"use strict";var Schema=require("mongoose").Schema,debug=require("debug")("eye:entity:monitor"),_=require("lodash"),properties=exports.properties={customer_name:{type:String,required:!0},looptime:{type:Number},config:{type:Object,default:{}},name:{type:String},type:{type:String},tags:{type:Array,default:[]}},EntitySchema=Schema(properties,{discriminatorKey:"_type"});exports.EntitySchema=EntitySchema,EntitySchema.virtual("id").get(function(){return this._id.toHexString()});var specs={getters:!0,virtuals:!0,transform:function(e,t,r){t.id=t._id,delete t._id,delete t._type,delete t.__v}};EntitySchema.set("toJSON",specs),EntitySchema.set("toObject",specs),EntitySchema.methods.publish=function(e,t){var r=this.toObject();return t&&t(null,r),r},EntitySchema.statics.publishAll=function(e,t){if(!e||0==e.length)return t([]);for(var r=[],o=_.after(e.length,function(){t(null,r)}),n=0;n<e.length;n++){var i=e[n];i.publish({},function(e,t){r.push(t),o()})}},EntitySchema.methods.setUpdates=function(e,t){t=t||function(){};var r=this,o=r.type;debug('updating resource monitor type "%s"',o),e.looptime&&(r.looptime=e.looptime),"boolean"==typeof e.enable&&(r.enable=e.enable),e.host_id&&(r.host_id=e.host_id),e.tags&&(r.tags=e.tags),(e.name||e.description)&&(r.name=e.name||e.description,r.description=e.description||e.name);var n=r.config;switch(e.config&&_.assign(e,e.config),o){case"scraper":r.host_id=e.external_host_id||e.host_id,n.external=Boolean(e.external_host_id),n.url=e.url,n.timeout=e.timeout,n.method=e.method,n.json="true"==e.json||e.json===!0,n.gzip="true"==e.gzip||e.gzip===!0,n.parser=e.parser,n.status_code=e.status_code,n.body=e.body,"pattern"==e.parser?(n.pattern=e.pattern,n.script=null):"script"==e.parser?(n.pattern=null,n.script=e.script):(n.pattern=null,n.script=null);break;case"process":e.ps&&_.assign(e,e.ps),e.pattern&&(n.ps.pattern=e.pattern),e.psargs&&(n.ps.psargs=e.psargs);break;case"script":e.script_id&&(n.script_id=e.script_id),e.script_arguments&&(n.script_arguments=e.script_arguments),e.script_runas&&(n.script_runas=e.script_runas);break;case"dstat":e.limit&&_.assign(e,e.limit),e.cpu&&(n.limit.cpu=e.cpu),e.mem&&(n.limit.mem=e.mem),e.cache&&(n.limit.cache=e.cache),e.disk&&(n.limit.disk=e.disk);break;case"psaux":break;default:return t(new Error('monitor type "'+o+'" unsupported'))}r.config=n;var i={};for(var s in r.toObject())"_id"!=s&&"__v"!=s&&(i[s]=r[s]);debug("monitor properties set to %j",i),t(null,i)};