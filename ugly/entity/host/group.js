"use strict";var mongodb=require("../../lib/mongodb"),Schema=require("mongoose").Schema,debug=require("debug")("eye:entity:host:group"),_=require("lodash"),TaskTemplate=require("../task/template").Entity,MonitorTemplate=require("../monitor/template").Entity,properties={customer:{type:Schema.Types.ObjectId,ref:"Customer",required:!0,index:!0},customer_name:{type:String},hostname_regex:{type:String,required:!0},task_templates:[{type:Schema.Types.ObjectId,ref:"TaskTemplate"}],provisioning_task_templates:[{type:Schema.Types.ObjectId,ref:"TaskTemplate"}],resource_templates:[{type:Schema.Types.ObjectId,ref:"ResourceTemplate"}],monitor_templates:[{type:Schema.Types.ObjectId,ref:"MonitorTemplate"}],enable:{type:Boolean,default:!0}},EntitySchema=Schema(properties);EntitySchema.methods.publish=function(e,t){var r=this,t=t||function(){};debug("publishing group"),Entity.populate(r,[{path:"task_templates"},{path:"resource_templates"},{path:"monitor_templates"},{path:"provisioning_task_templates"}],function(e,r){var o={id:r._id,customer_name:r.customer_name,hostname_regex:r.hostname_regex,tasks:[],resources:r.resource_templates,monitors:r.monitor_templates,provisioning_tasks:r.provisioning_task_templates,enable:r.enable},n=0;n+=r.task_templates.length?1:0,n+=r.monitor_templates.length?1:0;var i=_.after(n,function(){debug("group publishing done"),t(null,o)});return n?(r.task_templates.length>0&&TaskTemplate.publishAll(r.task_templates,function(e,t){o.tasks=t,i()}),void(r.monitor_templates.length>0&&MonitorTemplate.publishAll(r.monitor_templates,function(e,t){o.monitors=t,i()}))):i()})},EntitySchema.methods.populate=function(e){var t=this;Entity.populate(t,[{path:"task_templates"},{path:"resource_templates"},{path:"monitor_templates"},{path:"provisioning_task_templates"}],function(t,r){e(t,r)})},EntitySchema.methods.setTemplatesProperty=function(e,t){var r=this;if(!t||t instanceof Array&&0==t.length)return doneFn(new Error("invalid templates values"));if(!e||!r.toObject().hasOwnProperty(e))return doneFn(new Error("invalid templates property"));for(var o=0;o<t.length;o++)r[e].push(t[o]);return r},EntitySchema.methods.detachTaskTemplate=function(e,t){t||(t=function(){});var r=e._id;Entity.update(this,{$pullAll:{task_templates:[r]}},function(e){t()})},EntitySchema.methods.detachMonitorTemplate=function(e,t){function r(e,t){Entity.update(this,{$pullAll:{monitor_templates:[e]}},t)}function o(e,t){Entity.update(this,{$pullAll:{resource_templates:[e]}},t)}t||(t=function(){});var n=e._id;r(n,function(r){if(r)return t(r);var n=e.template_resource;o(n,function(e){return e?t(e):void t()})})},EntitySchema.methods.addMonitorTemplate=function(e){var t=e.monitor_template,r=e.resource_template;return this.monitor_templates.push(t),this.resource_templates.push(r),this},EntitySchema.methods.hasTaskTemplate=function(e){return this.task_templates.indexOf(e._id)!=-1},EntitySchema.methods.hasMonitorTemplate=function(e){return this.monitor_templates.indexOf(e._id)!=-1};var Entity=mongodb.db.model("HostGroup",EntitySchema);Entity.ensureIndexes(),exports.EntitySchema=EntitySchema,exports.Entity=Entity;