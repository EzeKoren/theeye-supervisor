"use strict";var mongodb=require("../lib/mongodb"),Schema=require("mongoose").Schema,path=require("path"),config=require("config"),uploadFolderPath=config.get("system").file_upload_folder,update=require("./update.js"),EntitySchema=Schema({customer_id:{type:String},customer_name:{type:String},user_id:{type:String},filename:{type:String},keyname:{type:String},mimetype:{type:String},extension:{type:String},size:{type:Number},creation_date:{type:Date,default:Date.now},last_update:{type:Date,default:Date.now},description:{type:String,default:""},md5:{type:String,default:null},public:{type:Boolean,default:!1},tags:{type:Array,default:[]}});EntitySchema.methods.getFullPath=function(){return path.join(uploadFolderPath,this.customer_name,"scripts",this.filename)},EntitySchema.methods.getCleanFilename=function(e){return this.keyname.replace(/\[ts:.*\]/,"")},EntitySchema.methods.publish=function(e){var t=this.toObject();return e(null,t),t},EntitySchema.methods.update=function(e,t){return update.call(this,e,t)},EntitySchema.statics.create=function(e,t){var r={customer_id:e.customer._id,customer_name:e.customer.name,user_id:e.user._id,filename:e.filename,keyname:e.keyname,mimetype:e.mimetype,extension:e.extension,size:e.size,creation_date:new Date,last_update:new Date,description:e.description||e.filename,md5:e.md5,public:e.public},o=new Entity(r);o.save(function(e){t(e,o)})},EntitySchema.virtual("id").get(function(){return this._id.toHexString()});var specs={getters:!0,virtuals:!0,transform:function(e,t,r){t.id=t._id,delete t._id,delete t.__v}};EntitySchema.set("toJSON",specs),EntitySchema.set("toObject",specs);var Entity=mongodb.db.model("Script",EntitySchema);Entity.ensureIndexes(),exports.Entity=Entity;