"use strict";var ObjectId=require("mongoose").Schema.Types.ObjectId,lodash=require("lodash"),mongodb=require("../../lib/mongodb").db,BaseSchema=require("./schema"),Template=require("./template").Entity,logger=require("../../lib/logger")("eye:entity:task"),Script=require("../script").Entity,Host=require("../host").Entity,TaskSchema=BaseSchema.EntitySchema.extend({host_id:{type:String,default:null},host:{type:ObjectId,ref:"Host",default:null},template:{type:ObjectId,ref:"TaskTemplate",default:null},script_arguments:{type:Array,default:[]},script_runas:{type:String,default:""},type:{type:String,default:"script"},script_id:{type:String,ref:"Script"}},{collection:"tasks",discriminatorKey:"_type"});exports.TaskSchema=TaskSchema,TaskSchema.methods.publish=function(e){function t(t){t||(t={});var o=r.toObject();t.host&&(o.host_id=t.host.id,o.hostname=t.host.hostname),t.script&&(o.script_id=t.script.id,o.script_name=t.script.filename),e(o)}var r=this,o={host:null,script:null},n=lodash.after(2,function(){return t(o)});r.host_id?Host.findById(r.host_id,function(e,t){e&&null==t||(o.host=t),n()}):n(),r.script_id?Script.findById(r.script_id,function(e,t){e&&null==t||(o.script=t),n()}):n()},TaskSchema.methods.toTemplate=function(e){var t=this,r={};for(var o in BaseSchema.properties)r[o]=t[o];var n=new Template(r);n.save(function(t){e(t,n)})},TaskSchema.statics.create=function(e,t){var r=new this;r.host_id=e.host?e.host._id:null,r.customer_id=e.customer._id,r.script_id=e.script._id,r.script_arguments=e.script_arguments,r.script_runas=e.script_runas,r.user_id=e.user._id,r.name=e.name||null,r.public=e.public||!1,r.template=e.template_id||null,r.description=e.description||null,r.tags=e.tags,r.save(function(e,r){t(e,r)})};var Entity=mongodb.model("Task",TaskSchema);Entity.ensureIndexes(),exports.Entity=Entity;