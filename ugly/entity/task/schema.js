"use strict";require("mongoose-schema-extend");var debug=require("debug")("eye:supervisor:entity:task"),Schema=require("mongoose").Schema,lodash=require("lodash"),properties=exports.properties={creation_date:{type:Date,default:Date.now()},last_update:{type:Date,default:Date.now()},user_id:{type:String,default:null},customer_id:{type:String,ref:"Customer"},public:{type:Boolean,default:!1},tags:{type:Array,default:[]},type:{type:String,required:!0},name:{type:String},description:{type:String},triggers:[{type:Schema.Types.ObjectId,ref:"Event",default:function(){return[]}}],grace_time:{type:Number,default:0}},EntitySchema=new Schema(properties);exports.EntitySchema=EntitySchema,EntitySchema.virtual("id").get(function(){return this._id.toHexString()});var specs={getters:!0,virtuals:!0,transform:function(e,t,r){t.id=t._id,delete t._id,delete t.__v,delete t.__t}};EntitySchema.set("toJSON",specs),EntitySchema.set("toObject",specs),EntitySchema.methods.update=function(e,t){var r=this,o=r.toObject();for(var n in e)o.hasOwnProperty(n)&&(r[n]=e[n]);debug("saving task %j",r),r.save(function(e){return e?t(e):void t(null,r)})},EntitySchema.statics.create=function(e,t){var r=new this;r.user_id=e.user_id||e.user._id,r.customer_id=e.customer_id||e.customer._id,r.script_id=e.script_id||e.script._id,r.script_arguments=e.script_arguments,r.script_runas=e.script_runas,r.name=e.name||null,r.description=e.description||null,r.tags=e.tags,r.save(function(e,r){t(null,r)})},EntitySchema.statics.publishAll=function(e,t){if(!e||0==e.length)return t([]);for(var r=[],o=lodash.after(e.length,function(){t(null,r)}),n=0;n<e.length;n++){var i=e[n];i.publish(function(e){r.push(e),o()})}};