"use strict";require("mongoose-schema-extend");var mongodb=require("../../lib/mongodb").db,BaseSchema=require("./schema"),Template=require("./template").Entity,ObjectId=require("mongoose").Schema.Types.ObjectId,debug=require("debug")("eye:entity:resource"),_=require("lodash"),INITIAL_STATE="normal",ResourceSchema=BaseSchema.EntitySchema.extend({host_id:{type:String},hostname:{type:String},fails_count:{type:Number,default:0},state:{type:String,default:INITIAL_STATE},enable:{type:Boolean,default:!0},creation_date:{type:Date,default:Date.now},template:{type:ObjectId,ref:"ResourceTemplate",default:null},last_check:{type:Date,default:null},last_update:{type:Date,default:Date.now},last_event:{type:Object,default:{}}});ResourceSchema.statics.INITIAL_STATE=INITIAL_STATE,ResourceSchema.statics.create=function(e,t){t||(t=function(){});var r=new Entity(e);r.host_id=e.host_id,r.hostname=e.hostname,r.template=e.template||null,r.save(function(e,r){if(e)throw e;t(null,r)})},ResourceSchema.methods.patch=function(e,t){t||(t=function(){}),this.update(e,function(e,r){t(e,r)})},ResourceSchema.methods.toTemplate=function(e){var t=this,r={};for(var o in BaseSchema.properties)r[o]=t[o];r.base_resource=t;var n=new Template(r);n.save(function(t){e(t,n)})},ResourceSchema.statics.FromTemplate=function(e,t,r){var o={host_id:t.host._id,hostname:t.host.hostname,template:e._id},n=_.extend(o,e.toObject());n.description=n.description,n.name=n.name,delete n._id,debug("creating resource from template %j",n);var i=new this(n);i.last_update=new Date,i._type="Resource",i.save(function(e){e&&(debug("ERROR with %j",n),debug(e.message)),r(e,i)})};var Entity=mongodb.model("Resource",ResourceSchema);Entity.ensureIndexes(),exports.Entity=Entity;